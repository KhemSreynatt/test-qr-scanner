<!DOCTYPE html>
<html>

<head>
    <title>Attendance Scanner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>
    <div id="result">Tap the button below to scan attendance QR code</div>
    <script>
        let tg = window.Telegram.WebApp;

        function openQRScanner() {
            navigator.geolocation.getCurrentPosition(function (position) {
                let latitude = position.coords.latitude;
                let longitude = position.coords.longitude;

                tg.showScanQrPopup({
                    text: "Scan attendance QR code"
                }, function (qrCode) {
                    if (qrCode) {
                        let scannedData = JSON.parse(qrCode);
                        let now = new Date().toISOString();

                        let attendanceData = {
                            ...scannedData,
                            scan_time: now,
                            latitude: latitude,
                            longitude: longitude,
                            user_name: tg.initDataUnsafe.user.first_name + " " + tg.initDataUnsafe.user.last_name
                        };

                        document.getElementById('result').textContent = "Processing...";

                        // Send to Django backend
                        fetch('/api/process-attendance/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(attendanceData),
                        })
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('result').textContent = data.message;
                            });
                    } else {
                        document.getElementById('result').textContent = "Scanning cancelled or failed";
                    }
                });
            }, function (error) {
                console.error("Error getting location:", error);
                document.getElementById('result').textContent = "Error getting location. Please enable location services.";
            });
        }

        tg.MainButton.text = "Scan Attendance QR";
        tg.MainButton.onClick(openQRScanner);
        tg.MainButton.show();
    </script>
</body>

</html>